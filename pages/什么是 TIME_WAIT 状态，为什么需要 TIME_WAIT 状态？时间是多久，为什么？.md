title:: 什么是 TIME_WAIT 状态，为什么需要 TIME_WAIT 状态？时间是多久，为什么？

- #CruelFundamental #[[2022-08-08]] #计算机网络 #TCP
-
- ![Replaced by Image Uploader](https://vip2.loli.io/2022/08/08/aw5coTdSxhbDQCs.png)
-
- [[TCP]] 中，在终止连接时（**任何一端均可主动终止连接**）会发送 FIN，同时对端在接收到此 FIN 且自己的消息也发送完后向发起终止方发送 FIN，发起终止方接收到对端发送的 FIN 后进入 TIME_WAIT 状态
- > TIME_WAIT 状态不属于客户端也不属于服务端，它属于的是要求终止的一端（首先发送 FIN 的）
- TIME_WAIT 的主要作用在于防止 ACK 丢失时 SEQ 被复用导致异常 ，需等待 2 * [[MSL]]
-
- > 在网上各种文章中，对于 TIME_WAIT 的解释似乎都只有「防止 ACK 丢失」，但没有说丢失了到底会怎么样
  > 
  > 我当时的反应：丢了就丢了呗，对方重发 FIN 发现被 RST 了直接断了不也一样吗？为什么非得挂着等浪费资源？
  >
  > 事实上，本质而言，TIME_WAIT 是防止端口和 SEQ 被复用导致异常
-
- ## 发起相同连接导致异常
	- 该问题通常出现于客户端主动断开连接
	- 如果在 TIME_WAIT 阶段中，ACK 丢失了，那么 **这条连接在发起方认为已经是没有的了而在对端认为仍然存活**
	- 如果在 ACK 丢失后立刻向对端同端口发送请求是有概率得到与前述正在关闭中的连接相同的端口和 SEQ 的，这时如果发送 SYN 会导致对方错误地认为是旧连接而 RST
-
- ## 包阻塞延迟导致异常
	- 如果在前置连接中，有包