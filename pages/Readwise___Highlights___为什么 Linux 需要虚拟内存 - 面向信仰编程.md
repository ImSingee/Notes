title:: Readwise/Highlights/为什么 Linux 需要虚拟内存 - 面向信仰编程
author:: [[draveness.me]]
full-title:: 为什么 Linux 需要虚拟内存 - 面向信仰编程
category:: #articles
url:: https://draveness.me/draveness.me/whys-the-design-os-virtual-memory

- 虚拟内存是操作系统物理内存和进程之间的中间层，它为进程隐藏了物理内存这一概念，为进程提供了更加简洁和易用的接口以及更加复杂的功能。 #Highlight #[[2022-07-02]]
- 主存储是相对比较稀缺的资源，虽然顺序读取只比磁盘快 1 个数量级，但是它能提供极快的随机访问速度，从内存上随机读取数据是磁盘的 100,000 倍3，充分利用内存的随机访问速度是改善程序执行效率的有效方式。 #Highlight #[[2022-07-02]]
- 操作系统以页为单位管理内存，当进程发现需要访问的数据不在内存时，操作系统可能会将数据以页的方式加载到内存中 #Highlight #[[2022-07-02]]
- 操作系统的虚拟内存作为一个抽象层，起到了以下三个非常关键的作用：虚拟内存可以利用内存起到缓存的作用，提高进程访问磁盘的速度；虚拟内存可以为进程提供独立的内存空间，简化程序的链接、加载过程并通过动态库共享内存；虚拟内存可以控制进程对物理内存的访问，隔离不同进程的访问权限，提高系统的安全性； #Highlight #[[2022-07-02]]
- 虚拟内存中的虚拟页（Virtual Page，VP）可能处于以下的三种状态 — 未分配（Unallocated）、未缓存（Uncached）和已缓存（Cached），其中未分配的内存页是没有被进程申请使用的，也就是空闲的虚拟内存，不占用虚拟内存磁盘的任何空间，未缓存和已缓存的内存页分别表示仅加载到磁盘中的内存页和已经加载到主存中的内存页 #Highlight #[[2022-07-02]]
- 当用户程序访问未被缓存的虚拟页时，硬件就会触发缺页中断（Page Fault，PF），在部分情况下，被访问的页面已经加载到了物理内存中，但是用户程序的页表（Page Table）并不存在该对应关系，这时我们只需要在页表中建立虚拟内存到物理内存的关系；在其他情况下，操作系统需要将磁盘上未被缓存的虚拟页加载到物理内存中4。 #Highlight #[[2022-07-02]]
- 因为主内存的空间是有限的，当主内存中不包含可以使用的空间时，操作系统会从选择合适的物理内存页驱逐回磁盘，为新的内存页让出位置，选择待驱逐页的过程在操作系统中叫做页面替换（Page Replacement） #Highlight #[[2022-07-02]]
- 因为有多层的页表结构可以用来转换虚拟地址，所以多个进程可以通过虚拟内存共享物理内存 #Highlight #[[2022-07-02]]
- 在 Linux 中调用 fork 创建子进程时，实际上只复制了父进程的页表 #Highlight #[[2022-07-02]]
- 除了能够共享内存之外，独立的虚拟内存空间也会简化内存的分配过程，当用户程序向操作系统申请堆内存时，操作系统可以分配几个连续的虚拟页，但是这些虚拟页可以对应到物理内存中不连续的页中。 #Highlight #[[2022-07-02]]