title:: Readwise/Highlights/03 | 基础篇：经常说的 CPU 上下文切换是什么意思？（上） - Linux性能优化实战 (65)
author:: [[倪朋飞]]
full-title:: 03 | 基础篇：经常说的 CPU 上下文切换是什么意思？（上） - Linux性能优化实战
category:: #articles
url:: https://time.geekbang.org/column/article/69859

- 跟进程上下文不同，中断上下文切换并不涉及到进程的用户态。 #Highlight #[[2020-03-21]]
- 所以，即便中断过程打断了一个正处在用户态的进程，也不需要保存和恢复这个进程的虚拟内存、全局变量等用户态资源。中断上下文，其实只包括内核态中断服务程序执行所必需的状态，包括 CPU 寄存器、内核堆栈、硬件中断参数等。 #Highlight #[[2020-03-21]]
- 前后两个线程属于同一个进程。此时，因为虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不动，只需要切换线程的私有数据、寄存器等不共享的数据。 #Highlight #[[2020-03-21]]
- 所谓内核中的任务调度，实际上的调度对象是线程；而进程只是给线程提供了虚拟内存、全局变量等资源。 #Highlight #[[2020-03-21]]
- 线程是调度的基本单位，而进程则是资源拥有的基本单位 #Highlight #[[2020-03-21]]
- Linux 为每个 CPU 都维护了一个就绪队列，将活跃进程（即正在运行和正在等待 CPU 的进程）按照优先级和等待 CPU 的时间排序，然后选择最需要 CPU 的进程，也就是优先级最高和等待 CPU 时间最长的进程来运行。 #Highlight #[[2020-03-21]]
- Linux 通过 TLB（Translation Lookaside Buffer）来管理虚拟内存到物理内存的映射关系。当虚拟内存更新后，TLB 也需要刷新，内存的访问也会随之变慢。特别是在多处理器系统上，缓存是被多个处理器共享的，刷新缓存不仅会影响当前处理器的进程，还会影响共享缓存的其他处理器的进程。 #Highlight #[[2020-03-21]]
- 每次上下文切换都需要几十纳秒到数微秒的 CPU 时 #Highlight #[[2020-03-21]]
- 进程的切换只能发生在内核态。所以，进程的上下文不仅包括了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的状态。 #Highlight #[[2020-03-21]]
- 系统调用过程通常称为特权模式切换，而不是上下文切换 #Highlight #[[2020-03-21]]
- 系统调用过程中一直是同一个进程在运行。 #Highlight #[[2020-03-21]]
- 系统调用过程中，并不会涉及到虚拟内存等进程用户态的资源，也不会切换进程。这跟我们通常所说的进程上下文切换是不一样的： #Highlight #[[2020-03-21]]
- 一次系统调用的过程，其实是发生了两次 CPU 上下文切换。 #Highlight #[[2020-03-21]]