title:: Readwise/Highlights/为什么数据库不应该使用外键 - 面向信仰编程 (65)
author:: [[draveness.me]]
full-title:: 为什么数据库不应该使用外键 - 面向信仰编程
category:: #articles
url:: https://draveness.me/draveness.me/whys-the-design-database-foreign-key

- 外键不仅仅是数据库表中的一个整数，它还提供了额外的一致性保证。因为数据库往往是整个系统的真理之源（Source of Truth），所以保证数据的一致性和正确性非常重要，关系型数据库虽然提供了外键、触发器等特性保证一致性，但是在今天的生产环境中却很少被使用。 #Highlight #[[2022-07-01]]
- 由于外键等特性需要数据库执行额外的工作，而这些操作会占用数据库的计算资源，所以我们可以将大部分的需求都迁移到无状态的服务中完成以降低数据库的工作负载。 #Highlight #[[2022-07-01]]
- 使用外键的用例在每次测试中都明显弱于不使用外键的用例，外键带来的额外开销分别为 ~2.47%、~0.02%、~10.41% 和 ~11.52%。这里的基准测试只是一个比较简单的定量分析，但是我们也可以从结果中看到大概的趋势 — 外键的完整性检查确实会带来额外的性能开销，而这些开销在高并发的服务中需要慎重考虑。 #Highlight #[[2022-07-01]]
- 模拟外键方法其实远比使用外键更消耗资源，它不仅需要查询关联数据，还要通过网络发送更多的数据包 #Highlight #[[2022-07-01]]
- 涉及多级的级联删除行为在数据量较小的数据库中不会导致问题，但是在数据量较大的数据库中删除关键数据可能会引起雪崩，一条记录的删除可能会被放大到几十倍甚至上百倍，这些对磁盘的随机读写会带来巨大的开销 #Highlight #[[2022-07-01]]
- 如果我们能够接受在一个时间窗口内的数据不一致，就可以将一个大号的删除任务拆成多个子任务分批执行，降低对数据库影响的峰值 #Highlight #[[2022-07-01]]