title:: Readwise/Highlights/19｜闭包：FnOnce、FnMut和Fn，为什么有这么多类型？ - 陈天 · Rust 编程第一课
author:: [[陈天]]
full-title:: 19｜闭包：FnOnce、FnMut和Fn，为什么有这么多类型？ - 陈天 · Rust 编程第一课
category:: #articles
url:: https://time.geekbang.org/column/article/424009

- 闭包是一种匿名类型，一旦声明，就会产生一个新的类型，但这个类型无法被其它地方使用。这个类型就像一个结构体，会包含所有捕获的变量。 #Highlight #[[2023-10-13]]
- 在 Rust 里，闭包产生的匿名数据类型，格式和 struct 是一样的。看图中 gdb 的输出，闭包是存储在栈上，并且除了捕获的数据外，闭包本身不包含任何额外函数指针指向闭包的代码 #Highlight #[[2023-10-13]]
- 闭包最大的问题是变量的多重引用导致生命周期不明确，所以你先想，其它支持闭包的语言（lambda 也是闭包），它们的闭包会放在哪里？
  栈上么？是，又好像不是。
  因为闭包这玩意，从当前上下文中捕获了些变量，变得有点不伦不类，不像函数那样清楚，尤其是这些被捕获的变量，它们的归属和生命周期处理起来很麻烦。所以，大部分编程语言的闭包很多时候无法放在栈上，需要额外的堆分配。你可以看这个 Golang 的例子。
  不光 Golang，Java / Swift / Python / JavaScript 等语言都是如此，这也是为什么大多数编程语言闭包的性能要远低于函数调用。因为使用闭包就意味着：额外的堆内存分配、潜在的动态分派（很多语言会把闭包处理成函数指针）、额外的内存回收。
  在性能上，唯有 C++ 的 lambda 和 Rust 闭包类似，不过 C++ 的闭包还有一些场景会触发堆内存分配 #Highlight #[[2023-10-13]]