title:: Readwise/Highlights/Overlay Filesystem — The Linux Kernel Documen...
author:: [[kernel.org]]
full-title:: Overlay Filesystem — The Linux Kernel Documentation
category:: #articles
url:: https://docs.kernel.org/filesystems/overlayfs.html
- While directories will report an st_dev from the overlay-filesystem, non-directory objects may report an st_dev from the lower filesystem or upper filesystem that is providing the object. ([View Highlight](https://read.readwise.io/read/01h2a7hh5bqg76wymswafdnwb4)) #Highlight #[[2023-06-07]]
- In the special case of all overlay layers on the same underlying(基础) filesystem, all objects will report an st_dev from the overlay filesystem and st_ino from the underlying(基础) filesystem ([View Highlight](https://read.readwise.io/read/01h2a7m7qavbjdrsjby43qjn5x)) #Highlight #[[2023-06-07]]
- The upper filesystem will normally be writable and if it is it must support the creation of trusted.* and/or user.* extended attributes, and must provide valid d_type in readdir responses, so NFS is not suitable. ([View Highlight](https://read.readwise.io/read/01h2a8bttw9d9c2mbjc2vxfmwb)) #Highlight #[[2023-06-07]]
- Only the lists of names from directories are merged. Other content such as metadata and extended attributes are reported for the upper directory only. These attributes of the lower directory are hidden. ([View Highlight](https://read.readwise.io/read/01h2a9q6tws2755fdsne40q2ep)) #Highlight #[[2023-06-07]]
- A whiteout is created as a character device with 0/0 device number. When a whiteout is found in the upper level of a merged directory, any matching name in the lower level is ignored, and the whiteout itself is also hidden. ([View Highlight](https://read.readwise.io/read/01h2a9r9nectxvad4sn73t433c)) #Highlight #[[2023-06-07]]
- A directory is made opaque(晦涩) by setting the xattr "trusted.overlay.opaque(晦涩)" to "y". Where the upper filesystem contains an opaque(晦涩) directory, any directory in the lower filesystem with the same name is ignored. ([View Highlight](https://read.readwise.io/read/01h2a9ryhr0kms0z2891ryrkva)) #Highlight #[[2023-06-07]]
- If the "redirect_dir" feature is enabled, then the directory will be copied up (but not the contents). Then the "trusted.overlay.redirect" extended attribute is set to the path of the original location from the root of the overlay. Finally the directory is moved to the new location. ([View Highlight](https://read.readwise.io/read/01h2aac7angdkmhm18vfxjd6vd)) #Highlight #[[2023-06-07]]
- The copy_up may turn out to be unnecessary, for example if the file is opened for read-write but the data is not modified. ([View Highlight](https://read.readwise.io/read/01h2abd6v24gyz3gjnx9qp1hyy)) #Highlight #[[2023-06-07]]
- The copy_up process first makes sure that the containing directory exists in the upper filesystem - creating it and any parents as necessary. It then creates the object with the same metadata (owner, mode, mtime, symlink-target etc.) and then if the object is a file, the data is copied from the lower to the upper filesystem. Finally any extended attributes are copied up. ([View Highlight](https://read.readwise.io/read/01h2abdb24bwnfdb2xrj5rd8rv)) #Highlight #[[2023-06-07]]
- When metadata only copy up feature is enabled, overlayfs will only copy up metadata (as opposed to whole file), when a metadata specific operation like chown/chmod is performed. Full file will be copied up later when file is opened for WRITE operation. ([View Highlight](https://read.readwise.io/read/01h2absv59vexrypt9438ypeny)) #Highlight #[[2023-06-07]]