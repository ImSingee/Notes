title:: Readwise/Highlights/02｜聊聊x86体系架构中的实模式和保护模式 - 编程高手必学的内存知识
author:: [[海纳]]
full-title:: 02｜聊聊x86体系架构中的实模式和保护模式 - 编程高手必学的内存知识
category:: #articles
url:: https://time.geekbang.org/column/article/431400

- 中断根据中断来源的不同，又可以细分为 Fault、Trap、Abort 以及普通中断。我们这门课对它们也不加区分，例如执行除法的时候除数为 0 的情况、访问数据时权限不足引发的保护错误、由用户使用 int 指令产生的中断等，虽然中断源不同，它们的类型也不相同，但我们统一称它们为中断。 #Highlight #[[2022-10-21]]
- 现代的操作系统都是采用段式管理来做基本的权限管理，而对于内存的分配、回收、调度都是依赖页式管理。 #Highlight #[[2022-10-21]]
- 64 位 Linux 系统，它把所有段的基地址都设成了从 0 开始，段长度设置为最大。这样段式管理的重要性就大大下降了。 #Highlight #[[2022-10-21]]
- 定义段长度的“段界限”字段并不是连续的，它一共有 20 位，分散在两个地方。当 G=1 时，段界限的最大值是 2^20 * 4K = 4G，这是 i386 一个段的最大长度。 #Highlight #[[2022-10-21]]
- G 位，它指的是定义段颗粒度（Granularity），它的值为 0 时，段界限的单位是字节，为 1 时段界限以 4KB 为单位，也就是一页。 #Highlight #[[2022-10-21]]
- S 为 1 代表该描述符是数据段 / 代码段描述符，为 0 则代表系统段 / 门描述符。门是 i386 提供的用于切换特权级的机制，有调用门、陷阱门、中断门、任务门等。在 Linux 系统中，只使用了中断门描述符。 #Highlight #[[2022-10-21]]
- 由 CPU 的 MMU 将线性地址映射为物理地址，然后就可以交给地址总线去进行读写了。 #Highlight #[[2022-10-21]]
- 在 i386 上，地址总线是 32 位的，通用寄存器也变成 32 位的，这就意味着因为寄存器位数不够而产生的段基址寄存器已经失去了作用。
  但是 i386 没有直接放弃掉段寄存器，而是将它进化成了新的段式内存管理。段寄存器仍然是 16 位寄存器，但是其中存的不再是段基址，而是被称为段选择子的东西。 #Highlight #[[2022-10-21]]
- CPU 没有强制规定代码段和数据段分离，也就意味着，你使用 ds 段寄存器去访问指令，CPU 也是允许的。但在实际编程时，我们还是会把数据和代码分到不同的段里，并且将数据段的起始地址放到 ds 寄存器，把代码段的地址放到 cs 寄存器。这种按功能分段的管理内存方式就是段式管理。 #Highlight #[[2022-10-21]]
- 8086 的寄存器位宽是 16 位，但地址总线却有 20 位，地址的编码可以从 20 位 0 到 20 位 1，这意味着 8086 的寻址空间是 2^20 = 1M。但是在写程序的时候，我们没有办法把一个地址完整地放到一个寄存器里，因为它的寄存器相比地址少了 4 位。
  为了解决这个问题，8086 就引入了段寄存器，例如 cs、ds、es、gs、ss 等。段寄存器中记录了一个段基地址，通过计算可以得到我们存储的真实地址，也就是物理地址。物理地址可以使用“段寄存器: 段内偏移”这样的格式来表示，计算的公式是：
  物理地址 = 段寄存器 << 4 + 段内偏移 #Highlight #[[2022-10-21]]
- 8086 的寄存器只有 16 位，我们也习惯于称 8086 的工作模式是 16 位模式。而且，后面的 CPU 为了保持兼容，在芯片上电了以后，还必须运行在 16 位模式之下，这种模式有个正式的名字，叫做实模式（Real Mode）。在实模式下，程序员是不能通过内存管理单元（Memory Management Unit, MMU）访问地址的，程序必须直接访问物理内存。 #Highlight #[[2022-10-21]]
- 从实模式演进到保护模式，x86 体系架构的内存管理发生了重大的变化，最大的不同就体现在段式管理和中断的管理上 #Highlight #[[2022-10-21]]
- CPU 上就出现虚拟内存的概念，它可以将每个进程的地址空间都隔离开，极大地减轻了程序员的负担，同时由于页表项中有多种权限保护标志，极大地提高了应用程序的数据安全。所以人们把 CPU 的这种工作模式称为保护模式（Protection Mode）。 #Highlight #[[2022-10-21]]
- 在内存管理上使用的是直接访问物理内存的方式，这种工作方式，有一个专门的名称，那就是实模式（Real Mode） #Highlight #[[2022-10-21]]